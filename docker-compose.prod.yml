# -------------------------------------------------------
#   docker-compose.prod.yml
# -------------------------------------------------------
version: "3.9"

services:
  # -------------------------------------------------
  # FastAPI‚Äë–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
  # -------------------------------------------------
  web:
    build:
      context: .
      dockerfile: app/Dockerfile.prod.yml
    command: >
      sh -c "alembic upgrade head &&
             python -m app.init_db &&
             gunicorn app.main:app
               --workers 4
               --worker-class uvicorn.workers.UvicornWorker
               --bind 0.0.0.0:8000
               --timeout 120"
    volumes:
      - media_data:/home/fast/app/media
    environment:
      - REDIS_HOST=${REDIS_HOST:-redis}
      - POSTGRES_HOST=${POSTGRES_HOST:-db}
      - POSTGRES_USER=${POSTGRES_USER:-ecommerce_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-xxxxxxxx}
      - POSTGRES_DB=${POSTGRES_DB:-ecommerce_db}
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
      - MAIL_FROM=${MAIL_FROM}
      - MAIL_PORT=${MAIL_PORT}
      - MAIL_SERVER=${MAIL_SERVER}
      - MAIL_FROM_NAME=${MAIL_FROM_NAME}
      - DOMAIN=${DOMAIN}
      - MEDIA_ROOT=/home/fast/app/media
      # S3‚Äëstorage
      - MEDIA_STORAGE=${MEDIA_STORAGE:-s3}
      - YC_S3_ENDPOINT=${YC_S3_ENDPOINT}
      - YC_S3_REGION=${YC_S3_REGION}
      - YC_S3_BUCKET=${YC_S3_BUCKET}
      - YC_S3_ACCESS_KEY_ID=${YC_S3_ACCESS_KEY_ID}
      - YC_S3_SECRET_ACCESS_KEY=${YC_S3_SECRET_ACCESS_KEY}
      - YC_S3_DEFAULT_ACL=${YC_S3_DEFAULT_ACL:-public-read}
      - YC_S3_PUBLIC_BASE_URL=${YC_S3_PUBLIC_BASE_URL}
    depends_on:
      - db
      - redis

  # -------------------------------------------------
  # Redis
  # -------------------------------------------------
  redis:
    image: redis:7-alpine
    user: "0:0"
    expose:
      - "6379"
    volumes:
      - redis_data:/data

  # -------------------------------------------------
  # Celery‚Äëworker
  # -------------------------------------------------
  celery_worker:
    build:
      context: .
      dockerfile: app/Dockerfile.prod.yml
    user: "0:0"
    command: celery -A app.core.celery_app worker --loglevel=info
    volumes:
      - media_data:/home/fast/app/media
    environment:
      - REDIS_HOST=${REDIS_HOST:-redis}
      - POSTGRES_HOST=${POSTGRES_HOST:-db}
      - POSTGRES_USER=${POSTGRES_USER:-ecommerce_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-xxxxxxxx}
      - POSTGRES_DB=${POSTGRES_DB:-ecommerce_db}
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
      - MAIL_FROM=${MAIL_FROM}
      - MAIL_PORT=${MAIL_PORT}
      - MAIL_SERVER=${MAIL_SERVER}
      - MAIL_FROM_NAME=${MAIL_FROM_NAME}
      - DOMAIN=${DOMAIN}
      - MEDIA_ROOT=/home/fast/app/media
      # S3‚Äëstorage
      - MEDIA_STORAGE=${MEDIA_STORAGE:-s3}
      - YC_S3_ENDPOINT=${YC_S3_ENDPOINT}
      - YC_S3_REGION=${YC_S3_REGION}
      - YC_S3_BUCKET=${YC_S3_BUCKET}
      - YC_S3_ACCESS_KEY_ID=${YC_S3_ACCESS_KEY_ID}
      - YC_S3_SECRET_ACCESS_KEY=${YC_S3_SECRET_ACCESS_KEY}
      - YC_S3_DEFAULT_ACL=${YC_S3_DEFAULT_ACL:-public-read}
      - YC_S3_PUBLIC_BASE_URL=${YC_S3_PUBLIC_BASE_URL}
    depends_on:
      - db
      - redis

  # -------------------------------------------------
  # PostgreSQL
  # -------------------------------------------------
  db:
    image: postgres:15
    user: "0:0"
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-ecommerce_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-xxxxxxxx}
      - POSTGRES_DB=${POSTGRES_DB:-ecommerce_db}

  # -------------------------------------------------
  # 1Ô∏è‚É£ –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ‚Äì –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
  # -------------------------------------------------
  certbot_init:
    image: certbot/certbot
    container_name: certbot_init
    restart: "no"
    # –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º entrypoint ‚Äì –∏–Ω–∞—á–µ —Å–∫—Ä–∏–ø—Ç –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã certbot
    entrypoint: ["sh", "-c"]
    command: |
      set -e
      # –ï—Å–ª–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É–∂–µ –µ—Å—Ç—å ‚Äì –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
      if [ -d "/etc/letsencrypt/live/${DOMAIN}" ]; then
        echo "‚úÖ Certificate already exists ‚Äì skipping creation"
        exit 0
      fi
      # –ü–æ–ª—É—á–∞–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —á–µ—Ä–µ–∑ standalone‚Äëmode (–ø–æ—Ä—Ç 80/443 –∑–∞–Ω—è—Ç—ã —ç—Ç–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º)
      certbot certonly --standalone ${STAGING}
        --email "${EMAIL}"
        --agree-tos
        --no-eff-email
        -d "${DOMAIN}" -d "www.${DOMAIN}"
    environment:
      - DOMAIN=${DOMAIN}
      - EMAIL=${CERTBOT_EMAIL:-admin@${DOMAIN}}
      # –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ staging‚Äë–æ–∫—Ä—É–∂–µ–Ω–∏–∏, –∑–∞–¥–∞–π—Ç–µ STAGING="--staging"
      - STAGING=${STAGING:-}
    volumes:
      - letsencrypt:/etc/letsencrypt          # —Ö—Ä–∞–Ω–∏—Ç live/ archive/ renewal/
      - certbot_www:/var/www/certbot
    ports:
      - "80:80"
      - "443:443"

  # -------------------------------------------------
  # 2Ô∏è‚É£ Nginx ‚Äì –ø—É–±–ª–∏—á–Ω—ã–π —Ñ—Ä–æ–Ω—Ç‚Äë—ç–Ω–¥
  # -------------------------------------------------
  nginx:
    build: nginx
    user: "0:0"
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - web
      - certbot_init          # –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ certbot_init –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è —Ä–∞–Ω—å—à–µ
    volumes:
      - letsencrypt:/etc/letsencrypt:ro
      - certbot_www:/var/www/certbot:ro
      - media_data:/home/fast/app/media:ro
    # –ñ–¥—ë–º –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (–∏–Ω–∞—á–µ Nginx –ø–∞–¥–∞–µ—Ç —Å—Ä–∞–∑—É)
    command: |
      sh -c '
        for i in $(seq 1 30); do
          if [ -f /etc/letsencrypt/live/${DOMAIN}/fullchain.pem ]; then
            echo "‚úÖ Certificate ready ‚Äì launching nginx";
            exec nginx -g "daemon off;";
          fi;
          echo "‚è≥ Waiting for certificate (${DOMAIN}) ‚Äì attempt $i/30";
          sleep 2;
        done;
        echo "‚ùå Certificate not found after 60‚ÄØs ‚Äì exiting";
        exit 1
      '

  # -------------------------------------------------
  # 3Ô∏è‚É£ –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ‚Äì –ø—Ä–æ–¥–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
  # -------------------------------------------------
  certbot:
    image: certbot/certbot
    container_name: certbot_renew
    restart: unless-stopped
    entrypoint: ["sh", "-c"]
    command: |
      while :; do
        echo "üîÅ Running certbot renew ‚Ä¶";
        certbot renew --quiet --deploy-hook "nginx -s reload";
        sleep 12h;
      done
    environment:
      - DOMAIN=${DOMAIN}
      - EMAIL=${CERTBOT_EMAIL:-admin@${DOMAIN}}
    volumes:
      - letsencrypt:/etc/letsencrypt
      - certbot_www:/var/www/certbot

volumes:
  postgres_data:
  redis_data:
  media_data:
  letsencrypt:          # —Ö—Ä–∞–Ω–∏—Ç /etc/letsencrypt/live, archive, renewal
  certbot_www:          # web‚Äëroot –¥–ª—è HTTP‚Äë01 —á–µ–ª–ª–µ–Ω–¥–∂–µ–π
