# -------------------------------------------------------
#  docker-compose.prod.yml
# -------------------------------------------------------
services:
  # -------------------------------------------------
  # FastAPI‚Äë–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
  # -------------------------------------------------
  web:
    build:
      context: .
      dockerfile: app/Dockerfile.prod.yml
    command: >
      sh -c "alembic upgrade head &&
             python -m app.init_db &&
             gunicorn app.main:app
               --workers 4
               --worker-class uvicorn.workers.UvicornWorker
               --bind 0.0.0.0:8000
               --timeout 120"
    volumes:
      - media_data:/home/fast/app/media
    environment:
      - REDIS_HOST=${REDIS_HOST:-redis}
      - POSTGRES_HOST=${POSTGRES_HOST:-db}
      - POSTGRES_USER=${POSTGRES_USER:-ecommerce_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-xxxxxxxx}
      - POSTGRES_DB=${POSTGRES_DB:-ecommerce_db}
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
      - MAIL_FROM=${MAIL_FROM}
      - MAIL_PORT=${MAIL_PORT}
      - MAIL_SERVER=${MAIL_SERVER}
      - MAIL_FROM_NAME=${MAIL_FROM_NAME}
      - DOMAIN=${DOMAIN}
      - MEDIA_ROOT=/home/fast/app/media
      # S3‚Äëstorage
      - MEDIA_STORAGE=${MEDIA_STORAGE:-s3}
      - YC_S3_ENDPOINT=${YC_S3_ENDPOINT}
      - YC_S3_REGION=${YC_S3_REGION}
      - YC_S3_BUCKET=${YC_S3_BUCKET}
      - YC_S3_ACCESS_KEY_ID=${YC_S3_ACCESS_KEY_ID}
      - YC_S3_SECRET_ACCESS_KEY=${YC_S3_SECRET_ACCESS_KEY}
      - YC_S3_DEFAULT_ACL=${YC_S3_DEFAULT_ACL:-public-read}
      - YC_S3_PUBLIC_BASE_URL=${YC_S3_PUBLIC_BASE_URL}
    depends_on:
      - db
      - redis

  # -------------------------------------------------
  # Redis
  # -------------------------------------------------
  redis:
    image: redis:7-alpine
    user: "0:0"
    expose:
      - "6379"
    volumes:
      - redis_data:/data

  # -------------------------------------------------
  # Celery‚Äëworker
  # -------------------------------------------------
  celery_worker:
    build:
      context: .
      dockerfile: app/Dockerfile.prod.yml
    user: "0:0"
    command: celery -A app.core.celery_app worker --loglevel=info
    volumes:
      - media_data:/home/fast/app/media
    environment:   # —Ç–µ –∂–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, —á—Ç–æ –∏ –≤ `web`
      - REDIS_HOST=${REDIS_HOST:-redis}
      - POSTGRES_HOST=${POSTGRES_HOST:-db}
      - POSTGRES_USER=${POSTGRES_USER:-ecommerce_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-xxxxxxxx}
      - POSTGRES_DB=${POSTGRES_DB:-ecommerce_db}
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
      - MAIL_FROM=${MAIL_FROM}
      - MAIL_PORT=${MAIL_PORT}
      - MAIL_SERVER=${MAIL_SERVER}
      - MAIL_FROM_NAME=${MAIL_FROM_NAME}
      - DOMAIN=${DOMAIN}
      - MEDIA_ROOT=/home/fast/app/media
      - MEDIA_STORAGE=${MEDIA_STORAGE:-s3}
      - YC_S3_ENDPOINT=${YC_S3_ENDPOINT}
      - YC_S3_REGION=${YC_S3_REGION}
      - YC_S3_BUCKET=${YC_S3_BUCKET}
      - YC_S3_ACCESS_KEY_ID=${YC_S3_ACCESS_KEY_ID}
      - YC_S3_SECRET_ACCESS_KEY=${YC_S3_SECRET_ACCESS_KEY}
      - YC_S3_DEFAULT_ACL=${YC_S3_DEFAULT_ACL:-public-read}
      - YC_S3_PUBLIC_BASE_URL=${YC_S3_PUBLIC_BASE_URL}
    depends_on:
      - db
      - redis

  # -------------------------------------------------
  # PostgreSQL
  # -------------------------------------------------
  db:
    image: postgres:15
    user: "0:0"
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-ecommerce_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-xxxxxxxx}
      - POSTGRES_DB=${POSTGRES_DB:-ecommerce_db}

  # -------------------------------------------------
  # 1Ô∏è‚É£ certbot_init ‚Äì –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
  # -------------------------------------------------
  certbot_init:
    image: certbot/certbot
    container_name: certbot_init
    restart: "no"
    entrypoint: ["sh", "-c"]
    command: >
      sh -c "if [ -d /etc/letsencrypt/live/${DOMAIN} ] && [ -f /etc/letsencrypt/live/${DOMAIN}/fullchain.pem ]; then
        echo '‚úÖ Certificate already exists ‚Äì skipping creation';
      else
        echo '‚åõ Waiting for nginx to be ready for challenge...';
        sleep 10;
        certbot certonly --webroot -w /var/www/certbot \
          --email ${EMAIL:-admin@${DOMAIN}} \
          --agree-tos \
          --no-eff-email \
          --manual-public-ip-logging-ok \
          -d ${DOMAIN} ${STAGING};
      fi"
    environment:
      - DOMAIN=${DOMAIN}
      - EMAIL=${CERTBOT_EMAIL:-${EMAIL}}
      - STAGING=${STAGING:-}
    volumes:
      - letsencrypt:/etc/letsencrypt
      - certbot_www:/var/www/certbot
    depends_on:
      - nginx

  # -------------------------------------------------
  # 2Ô∏è‚É£ nginx ‚Äì —Ñ—Ä–æ–Ω—Ç‚Äë—ç–Ω–¥
  # -------------------------------------------------
  nginx:
    build: nginx
    user: "0:0"
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - web
    environment:
      - DOMAIN=${DOMAIN}
    volumes:
      - letsencrypt:/etc/letsencrypt
      - certbot_www:/var/www/certbot:ro
      - media_data:/home/fast/app/media:ro
    # –û–∂–∏–¥–∞–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (–µ—Å–ª–∏ –æ–Ω –µ—â—ë —Å–æ–∑–¥–∞—ë—Ç—Å—è)
    command: |
      sh -c '
        set -e
        # –°–æ–∑–¥–∞–µ–º —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç, —á—Ç–æ–±—ã Nginx –Ω–µ —É–ø–∞–ª –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        if [ ! -f /etc/letsencrypt/live/${DOMAIN}/fullchain.pem ]; then
          echo "‚ö†Ô∏è No certificate found for ${DOMAIN} ‚Äì creating dummy certificate for start";
          mkdir -p /etc/letsencrypt/live/${DOMAIN};
          openssl req -x509 -nodes -newkey rsa:2048 -days 1 \
            -keyout /etc/letsencrypt/live/${DOMAIN}/privkey.pem \
            -out /etc/letsencrypt/live/${DOMAIN}/fullchain.pem \
            -subj "/CN=localhost";
        fi;

        nginx -g "daemon off;" &
        NGINX_PID=$$!;

        # –§–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ—è–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
        (
          for i in $(seq 1 30); do
            sleep 10;
            if [ -f /etc/letsencrypt/live/${DOMAIN}/fullchain.pem ] && \
               ! grep -q "localhost" /etc/letsencrypt/live/${DOMAIN}/fullchain.pem; then
              echo "‚úÖ Real certificate ready ‚Äì reloading nginx";
              nginx -s reload;
              break;
            fi;
            echo "‚è≥ Waiting for real certificate (${DOMAIN}) ‚Äì attempt $$i/30";
          done
        ) &

        wait $$NGINX_PID;
      '

  # -------------------------------------------------
  # 3Ô∏è‚É£ certbot ‚Äì –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–¥–ª–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
  # -------------------------------------------------
  certbot:
    image: certbot/certbot
    container_name: certbot_renew
    restart: unless-stopped
    entrypoint: ["sh", "-c"]
    command: >
      sh -c "trap 'exit 0' TERM;
      while true; do
        echo 'üîÅ Running certbot renew ‚Ä¶';
        certbot renew --webroot -w /var/www/certbot --quiet;
        sleep 12h & wait $$!;
      done"
    environment:
      - DOMAIN=${DOMAIN}
      - EMAIL=${CERTBOT_EMAIL:-${EMAIL}}
    volumes:
      - letsencrypt:/etc/letsencrypt
      - certbot_www:/var/www/certbot

volumes:
  postgres_data:
  redis_data:
  media_data:
  letsencrypt:          # —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã Let‚Äôs Encrypt
  certbot_www:          # web‚Äëroot –¥–ª—è HTTP‚Äë01 —á–µ–ª–ª–µ–Ω–¥–∂–µ–π
