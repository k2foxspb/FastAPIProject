from fastapi import FastAPI, Request, statusfrom fastapi.exceptions import RequestValidationErrorfrom fastapi.responses import JSONResponsefrom fastapi.staticfiles import StaticFilesfrom pydantic import ValidationErrorfrom starlette.templating import Jinja2Templatesimport osfrom app.core.middleware import setup_middlewarefrom app.core.logging import setup_loggingfrom app.api.routers import api_routerfrom app.api.routers.health import router as health_routerfrom fastapi.exceptions import RequestValidationErrorfrom fastapi.responses import JSONResponsefrom loguru import loggertemplates = Jinja2Templates(directory="app/templates")def create_application() -> FastAPI:    """Фабрика для создания приложения FastAPI."""    # Настройка логирования    setup_logging()    # Создание приложения    app = FastAPI(        title="FastAPI Интернет-магазин",        version="0.1.0",        description="API для интернет-магазина",        docs_url="/docs",        redoc_url="/redoc",    )    # Настройка middleware    setup_middleware(app)    # Подключение роутеров    app.include_router(api_router, prefix="")    app.include_router(health_router)    # Static files (media)    # Use a single, consistent absolute path that matches docker-compose and Nginx    project_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))  # /home/fast/app    media_dir = os.path.join(project_root, "media")                             # /home/fast/app/media    # Create required media subfolders (no errors if volume is mounted readonly in nginx)    try:        os.makedirs(media_dir, exist_ok=True)        for subdir in ["users", "news", "products", "chat", "app"]:            os.makedirs(os.path.join(media_dir, subdir), exist_ok=True)    except Exception as e:        # In case of permission issues on a fresh named volume, continue startup;        # web will still serve existing files, and init job will fix ownership.        print(f"WARN: Could not ensure media directories at {media_dir}: {e}")    from fastapi.responses import FileResponse    class CustomStaticFiles(StaticFiles):        async def get_response(self, path: str, scope):            response = await super().get_response(path, scope)            if response.status_code == 404 and "_thumb" in path:                # Fallback to the original image if thumbnail is missing                original_path = path.replace("_thumb", "")                return await super().get_response(original_path, scope)            return response    print(f"DEBUG: Serving media from {media_dir}")    app.mount("/media", CustomStaticFiles(directory=media_dir), name="media")    # Добавляем отдачу файла верификации Mail.ru напрямую из корня    @app.get("/mailru-verification8af46e28aa4da5cb.html")    async def mailru_verification():        from fastapi.responses import FileResponse        file_path = os.path.join(project_root, "app", "mailru-verification8af46e28aa4da5cb.html")        return FileResponse(file_path)    @app.get("/")    async def get_index(request: Request):        return templates.TemplateResponse("index.html", {"request": request})    @app.get("/ws-test")    async def get_ws_test(request: Request):        return templates.TemplateResponse("ws_test.html", {"request": request})    @app.get("/chat-test")    async def get_chat_test(request: Request):        return templates.TemplateResponse("chat_test.html", {"request": request})    return app# Создание экземпляра приложенияapp = create_application()# Опционально: создание второй версии APIdef create_v2_application() -> FastAPI:    """Версия 2 API (если нужна)."""    app_v2 = FastAPI(        title="FastAPI Интернет-магазин",        version="0.2.0",        description="API для интернет-магазина v2",    )    # Настройки для v2...    return app_v2# app_v1 = create_v2_application()# app.mount('/v2', app_v1)