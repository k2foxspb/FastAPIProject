from fastapi import FastAPI, Request, statusfrom fastapi.exceptions import RequestValidationErrorfrom fastapi.responses import JSONResponsefrom fastapi.staticfiles import StaticFilesfrom pydantic import ValidationErrorfrom starlette.templating import Jinja2Templatesimport osfrom app.core.middleware import setup_middlewarefrom app.core.logging import setup_loggingfrom app.api.routers import api_routerfrom app.api.routers.health import router as health_routerfrom fastapi.exceptions import RequestValidationErrorfrom fastapi.responses import JSONResponsefrom loguru import loggertemplates = Jinja2Templates(directory="app/templates")def create_application() -> FastAPI:    """Фабрика для создания приложения FastAPI."""    # Настройка логирования    setup_logging()    # Создание приложения    app = FastAPI(        title="FastAPI Интернет-магазин",        version="0.1.0",        description="API для интернет-магазина",        docs_url="/docs",        redoc_url="/redoc",    )    @app.exception_handler(RequestValidationError)    async def validation_exception_handler(request: Request, exc: RequestValidationError):        logger.error(f"Validation error: {exc.errors()}")        logger.error(f"Body: {await request.body()}")        return JSONResponse(            status_code=status.HTTP_422_UNPROCESSABLE_ENTITY,            content={"detail": exc.errors(), "body": str(await request.body())},        )    # Настройка middleware    setup_middleware(app)    # Подключение роутеров    app.include_router(api_router, prefix="")    app.include_router(health_router)    # Статические файлы    # Ensure we use an absolute path for the media directory    app_dir = os.path.dirname(os.path.abspath(__file__))    media_dir = os.path.join(app_dir, "media")        os.makedirs(media_dir, exist_ok=True)        print(f"DEBUG: Serving media from {media_dir}")    app.mount("/media", StaticFiles(directory=media_dir), name="media")    @app.get("/ws-test")    async def get_ws_test(request: Request):        return templates.TemplateResponse("ws_test.html", {"request": request})    @app.get("/chat-test")    async def get_chat_test(request: Request):        return templates.TemplateResponse("chat_test.html", {"request": request})    return app# Создание экземпляра приложенияapp = create_application()# Опционально: создание второй версии APIdef create_v2_application() -> FastAPI:    """Версия 2 API (если нужна)."""    app_v2 = FastAPI(        title="FastAPI Интернет-магазин",        version="0.2.0",        description="API для интернет-магазина v2",    )    # Настройки для v2...    return app_v2# app_v1 = create_v2_application()# app.mount('/v2', app_v1)